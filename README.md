# Xaero's World Map - Документация модуля

## Общая информация

**Xaero's World Map** - это мод для Minecraft версии 1.12.2, который создает автоматически обновляемую полноэкранную карту мира. Мод также может работать как дополнение к Xaero's Minimap.

- **Версия мода**: 1.40.2
- **Версия Minecraft**: 1.12.2
- **Автор**: Xaero96
- **Mod ID**: `xaeroworldmap`
- **Зависимости**: 
  - `xaerolib@[1.0.42,)` (обязательная)
  - Совместимость с `xaerominimap@[25.3.2,)` и `xaerobetterpvp@[25.3.2,)`

## Описание

Мод автоматически создает и обновляет полноэкранную карту мира по мере исследования игроком. Карта сохраняется на диск и может быть экспортирована в формате PNG. Мод поддерживает работу в одиночной игре и на серверах, а также поддерживает множественные измерения (dimensions).

## Архитектура модуля

### Основные компоненты

#### 1. Главный класс мода (`WorldMap.java`)

Главный класс мода, который инициализирует все системы и управляет жизненным циклом мода.

**Ключевые статические поля:**
- `INSTANCE` - единственный экземпляр мода
- `worldMapClient` - клиентская часть мода
- `mapProcessor` - процессор карты
- `mapWriter` - записыватель данных карты
- `settings` - настройки мода
- `events` - обработчики событий клиента
- `controlsRegister` - регистратор элементов управления

**Основные методы жизненного цикла:**
- `preInit()` - предварительная инициализация (создание папок, настройка конфигурации)
- `load()` - основная загрузка (регистрация пакетов, инициализация пулов ресурсов)
- `postInit()` - пост-инициализация (загрузка настроек, проверка обновлений)

#### 2. Обработчик карты (`MapProcessor.java`)

Центральный компонент, отвечающий за обработку и обновление карты.

**Основные функции:**
- Управление загрузкой и сохранением регионов карты
- Обработка обновлений чанков
- Управление текстурами и рендерингом
- Синхронизация с игровым миром
- Управление измерениями (dimensions)

**Ключевые компоненты:**
- `MapSaveLoad` - загрузка и сохранение данных карты
- `MapWriter` - запись данных карты
- `TextureUploader` - загрузка текстур в GPU
- `WorldDataHandler` - обработка данных мира
- `BiomeColorCalculator` - расчет цветов биомов

#### 3. Записыватель карты (`MapWriter.java`)

Отвечает за запись данных карты на основе информации о блоках мира.

**Основные функции:**
- Анализ блоков в чанках
- Определение цветов блоков и биомов
- Создание текстур регионов
- Поддержка режима пещер (cave mode)
- Обработка прозрачных блоков

**Особенности:**
- Кэширование цветов блоков для производительности
- Поддержка множественных слоев (surface, cave)
- Обработка биомов и их цветов

#### 4. Сессия карты (`WorldMapSession.java`)

Управляет сессией карты для конкретного игрока/мира.

**Основные функции:**
- Инициализация компонентов карты при входе в мир
- Очистка ресурсов при выходе из мира
- Управление обработчиками управления
- Предоставление доступа к процессору карты

#### 5. Представление мира (`MapWorld.java`)

Представляет игровой мир и его измерения.

**Основные функции:**
- Управление измерениями (dimensions)
- Хранение информации о мультимире (multiworld)
- Управление соединениями между картами
- Настройка команд телепортации

### Подсистемы

#### Система регионов (`xaero.map.region`)

Карта разделена на регионы размером 8x8 чанков. Каждый регион содержит:
- `MapRegion` - основной класс региона
- `MapTileChunk` - данные чанка карты
- `MapTile` - отдельная плитка карты
- `RegionTexture` - текстура региона для рендеринга

#### Система рендеринга (`xaero.map.graphics`)

- `TextureUploader` - загрузка текстур в GPU
- `TextureUploadPool` - пулы для управления загрузкой текстур
- `BranchTextureRenderer` - рендеринг веток текстур
- `MapRenderHelper` - вспомогательные функции рендеринга
- `ImprovedFramebuffer` - улучшенный framebuffer для рендеринга

#### Система сохранения (`xaero.map.file`)

- `MapSaveLoad` - основной класс сохранения/загрузки
- `MapRegionInfo` - информация о регионе
- `RegionDetection` - обнаружение регионов
- `PNGExporter` - экспорт карты в PNG

#### Система GUI (`xaero.map.gui`)

- `GuiMap` - главный экран карты
- `GuiWorldMapSettings` - настройки карты
- `GuiMapSwitching` - переключение между картами
- `ExportScreen` - экран экспорта карты
- Различные вспомогательные GUI компоненты

#### Система элементов карты (`xaero.map.element`)

Элементы, отображаемые на карте:
- Иконки игроков
- Путевые точки (waypoints)
- Трекинг игроков
- Меню элементов карты

#### Система биомов (`xaero.map.biome`)

- `MapBiomes` - управление биомами
- `BiomeColorCalculator` - расчет цветов биомов
- `BiomeInfoSupplier` - поставщик информации о биомах

#### Система подсветки (`xaero.map.highlight`)

- `HighlighterRegistry` - регистр подсветок
- `ChunkHighlighter` - подсветка чанков
- `DimensionHighlighterHandler` - обработчик подсветки измерений
- `MapRegionHighlightsPreparer` - подготовка подсветок регионов

#### Система радара (`xaero.map.radar`)

Отслеживание игроков и сущностей:
- `PlayerTrackerSystemManager` - менеджер систем отслеживания
- `SyncedPlayerTrackerSystem` - синхронизированная система отслеживания
- Различные трекеры для разных модов

#### Система событий (`xaero.map.events`)

- `ClientEvents` - события клиента
- `CommonEvents` - общие события
- `ModCommonEvents` - события модов

#### Система управления (`xaero.map.controls`)

- `ControlsHandler` - обработчик управления
- `ControlsRegister` - регистратор элементов управления
- `KeyEvent` - события клавиатуры

#### Система конфигурации (`xaero.map.config`)

- Использует систему конфигурации XaeroLib
- Поддержка профилей конфигурации
- Синхронизация настроек между клиентом и сервером

#### Система модов (`xaero.map.mods`)

Интеграция с другими модами:
- `SupportMods` - поддержка различных модов
- Интеграция с Xaero's Minimap
- Поддержка серверных модов

#### Система пулов (`xaero.map.pool`)

Управление пулами ресурсов для оптимизации:
- `MapTilePool` - пул плиток карты
- `TextureDirectBufferPool` - пул буферов текстур
- Различные пулы для загрузки текстур

#### Система кэширования (`xaero.map.cache`)

- `BlockStateColorTypeCache` - кэш типов цветов блоков
- `BlockStateShortShapeCache` - кэш форм блоков

## Структура данных

### Регионы карты

Карта разделена на регионы размером 8x8 чанков (128x128 блоков). Каждый регион хранится в отдельном файле.

### Формат файлов

- Регионы сохраняются в папке `xaero/world-map/`
- Структура: `{worldId}/{dimensionId}/{multiworldId}/region_{x}_{z}.data`
- Поддерживается версионирование формата файлов

### Измерения (Dimensions)

Мод поддерживает работу с несколькими измерениями:
- Overworld (0)
- Nether (-1)
- End (1)
- Кастомные измерения

## Производительность

### Оптимизации

1. **Пул ресурсов** - переиспользование объектов для снижения нагрузки на GC
2. **Кэширование** - кэширование цветов блоков и форм
3. **Асинхронная загрузка** - загрузка регионов в отдельном потоке
4. **Lazy loading** - загрузка регионов по требованию
5. **Сжатие текстур** - использование сжатых текстур для экономии памяти

### Ограничения

- `MapLimiter` - ограничивает количество одновременно загружаемых регионов
- Настройки производительности в конфигурации

## Интеграция с другими модами

### Xaero's Minimap

Мод может работать как дополнение к Xaero's Minimap, синхронизируя данные между ними.

### Серверные моды

Поддержка различных серверных модов для синхронизации данных между игроками.

## Безопасность и обработка ошибок

- `CrashHandler` - обработчик сбоев
- `SilentException` - тихие исключения для некритичных ошибок
- `OpenGLException` - исключения OpenGL
- Проверка версий и совместимости

## Расширяемость

### API для разработчиков

Мод предоставляет интерфейсы для:
- Добавления кастомных элементов на карту
- Создания подсветок (highlighters)
- Интеграции с другими модами
- Кастомизации рендеринга

### Основные интерфейсы

- `MapElementReader` - чтение элементов карты
- `MapElementRenderer` - рендеринг элементов
- `AbstractHighlighter` - базовый класс для подсветок
- `IPlayerTrackerSystem` - система отслеживания игроков

## Конфигурация

### Файлы конфигурации

- Основные настройки: `config/xaero/world-map/`
- Старые настройки: `config/xaeroworldmap.txt` (legacy)

### Основные настройки

- Разрешение карты
- Режим пещер
- Настройки экспорта
- Настройки производительности
- Настройки синхронизации

## Экспорт карты

Мод поддерживает экспорт карты в формат PNG:
- `PNGExporter` - класс экспорта
- Экспорт может быть выполнен через GUI
- Экспортированные карты сохраняются в `map exports/`

## Технические детали

### Потоки выполнения

- Главный поток Minecraft - обработка событий, GUI
- `MapRunner` - отдельный поток для обработки карты
- Потоки рендеринга - для асинхронного рендеринга

### Синхронизация

Используются различные объекты синхронизации:
- `mainStuffSync` - синхронизация основных данных
- `renderThreadPauseSync` - пауза рендеринга
- `processorThreadPauseSync` - пауза обработки
- `loadingSync` - синхронизация загрузки

### Управление памятью

- `ByteBufferDeallocator` - деаллокатор буферов
- `GLObjectDeleter` - удаление OpenGL объектов
- Пул ресурсов для переиспользования

## Версионирование

- Формат версии: `{minecraft_version}_{mod_version}`
- Пример: `1.12_1.40.2`
- Поддержка миграции старых форматов файлов

## Известные ограничения

1. Требуется XaeroLib версии 1.0.42 или выше
2. Совместимость только с Minecraft 1.12.2
3. Некоторые функции требуют серверной поддержки

## Разработка

### Структура проекта

Проект использует стандартную структуру мода Forge:
- `xaero.map` - основной пакет
- Подпакеты для различных систем
- Использование аннотаций Forge (@Mod, @EventHandler)

### Трансформеры

Мод использует трансформеры для модификации классов Minecraft:
- `xaero.map.core.transformer` - пакет трансформеров
- Модификация классов для интеграции

## Лицензия и авторство

- Автор: Xaero96
- Мод является частью серии модов Xaero

## Дополнительная информация

Для получения дополнительной информации и поддержки обращайтесь к официальным ресурсам мода.

