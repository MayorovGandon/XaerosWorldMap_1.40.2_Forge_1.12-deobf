# Архитектура Xaero's World Map

## Обзор архитектуры

Мод использует многослойную архитектуру с четким разделением ответственности между компонентами.

## Основные слои

### 1. Слой инициализации

**Класс**: `WorldMap`
- Точка входа мода
- Управление жизненным циклом
- Инициализация глобальных ресурсов

### 2. Слой сессий

**Класс**: `WorldMapSession`
- Управление сессией для каждого мира
- Связывает компоненты в единое целое
- Управление жизненным циклом сессии

### 3. Слой обработки

**Класс**: `MapProcessor`
- Центральный координатор
- Управление загрузкой/сохранением
- Синхронизация с игровым миром

### 4. Слой записи

**Класс**: `MapWriter`
- Генерация данных карты
- Анализ блоков
- Создание текстур

### 5. Слой представления

**Класс**: `MapWorld`, `MapDimension`
- Представление структуры мира
- Управление измерениями
- Управление мультимирами

## Потоки данных

### Поток обновления карты

```
Игровой мир → Chunk Update → MapProcessor → MapWriter → MapRegion → Texture → GPU
```

1. Изменения в мире обнаруживаются через события Minecraft
2. `MapProcessor` получает уведомление об изменении
3. `MapWriter` анализирует измененные чанки
4. Данные записываются в `MapRegion`
5. Текстуры обновляются через `TextureUploader`
6. Изменения отображаются на экране

### Поток загрузки

```
Диск → MapSaveLoad → MapRegion → TextureUploader → GPU
```

1. `MapSaveLoad` читает данные с диска
2. Данные загружаются в `MapRegion`
3. Текстуры создаются и загружаются в GPU
4. Регион становится доступным для отображения

## Система регионов

### Иерархия регионов

```
MapWorld
  └── MapDimension
      └── MapRegion (8x8 чанков)
          └── MapTileChunk (1 чанк)
              └── MapTile (16x16 блоков)
```

### Структура региона

- **Размер**: 8x8 чанков = 128x128 блоков
- **Файл**: `region_{x}_{z}.data`
- **Версионирование**: Поддержка миграции форматов

### Уровни детализации

Мод использует систему веток (branch) для разных уровней детализации:
- **LeafRegionTexture** - полная детализация
- **BranchRegionTexture** - уменьшенная детализация для отдаленных регионов

## Система рендеринга

### Компоненты рендеринга

1. **TextureUploader**
   - Управляет загрузкой текстур в GPU
   - Использует пулы для оптимизации

2. **BranchTextureRenderer**
   - Рендерит ветки текстур
   - Управляет уровнями детализации

3. **MapRenderHelper**
   - Вспомогательные функции рендеринга
   - Оптимизации OpenGL

### Пул текстур

Используется несколько пулов для разных типов текстур:
- `normalTextureUploadPool` - обычные текстуры
- `compressedTextureUploadPool` - сжатые текстуры
- `branchUpdatePool` - обновления веток
- `branchDownloadPool` - загрузка веток

## Система кэширования

### Кэши блоков

1. **BlockStateColorTypeCache**
   - Кэширует типы цветов блоков
   - Ускоряет определение цветов

2. **BlockStateShortShapeCache**
   - Кэширует формы блоков
   - Оптимизирует анализ блоков

### Стратегия кэширования

- Кэш обновляется при изменении блоков
- Используется инвалидация кэша
- Поддержка прозрачных блоков

## Система биомов

### Компоненты

1. **MapBiomes**
   - Управление биомами
   - Хранение информации о биомах

2. **BiomeColorCalculator**
   - Расчет цветов биомов
   - Учет времени суток и погоды

3. **BiomeInfoSupplier**
   - Поставщик информации о биомах
   - Интерфейс для получения данных

## Система элементов карты

### Архитектура элементов

```
MapElementReader → MapElement → MapElementRenderer → Screen
```

### Типы элементов

1. **Иконки игроков**
   - Отображение позиций игроков
   - Поддержка трекинга

2. **Путевые точки**
   - Waypoints на карте
   - Кастомизация символов

3. **Меню элементов**
   - Контекстные меню
   - Взаимодействие с элементами

### Система рендеринга элементов

- `MapElementRenderHandler` - обработчик рендеринга
- `MapElementRenderProvider` - поставщик элементов
- `MapElementRenderLocation` - позиционирование

## Система подсветки

### Архитектура подсветки

```
HighlighterRegistry → AbstractHighlighter → MapRegionHighlightsPreparer → Render
```

### Типы подсветок

1. **ChunkHighlighter**
   - Подсветка чанков
   - Визуализация границ

2. **DimensionHighlighterHandler**
   - Подсветка измерений
   - Управление подсветками измерений

### Регистрация подсветок

- `HighlighterRegistry` - центральный регистр
- Поддержка кастомных подсветок
- Автоматическая подготовка подсветок

## Система сохранения

### Компоненты сохранения

1. **MapSaveLoad**
   - Основной класс сохранения/загрузки
   - Управление форматом файлов

2. **MapRegionInfo**
   - Метаданные регионов
   - Информация о версиях

3. **RegionDetection**
   - Обнаружение регионов
   - Валидация данных

### Формат сохранения

- Бинарный формат для производительности
- Версионирование для миграции
- Поддержка сжатия

## Система экспорта

### PNGExporter

- Экспорт карты в PNG
- Поддержка различных разрешений
- Пакетный экспорт

### Процесс экспорта

1. Загрузка регионов
2. Рендеринг в память
3. Конвертация в PNG
4. Сохранение файла

## Система событий

### Типы событий

1. **ClientEvents**
   - События клиента
   - Обработка тиков
   - Обработка GUI

2. **CommonEvents**
   - Общие события
   - Серверные события

3. **ModCommonEvents**
   - События модов
   - Интеграция с другими модами

### Обработка событий

- Регистрация через Forge Event Bus
- Асинхронная обработка где возможно
- Обработка ошибок

## Система управления

### ControlsHandler

- Обработка ввода
- Управление картой
- Горячие клавиши

### ControlsRegister

- Регистрация элементов управления
- Кастомизация клавиш
- Интеграция с настройками

## Система конфигурации

### Архитектура конфигурации

Использует систему конфигурации XaeroLib:
- Профили конфигурации
- Синхронизация клиент/сервер
- Версионирование настроек

### Типы настроек

1. **Primary Config**
   - Основные настройки
   - Глобальные параметры

2. **Client Config**
   - Клиентские настройки
   - Пользовательские предпочтения

3. **Common Config**
   - Общие настройки
   - Серверные параметры

## Система пулов ресурсов

### Типы пулов

1. **MapTilePool**
   - Пул плиток карты
   - Переиспользование объектов

2. **TextureDirectBufferPool**
   - Пул буферов текстур
   - Управление памятью GPU

3. **TextureUploadPool**
   - Пул загрузки текстур
   - Оптимизация загрузки

### Стратегия пулов

- Переиспользование объектов
- Автоматическая очистка
- Управление жизненным циклом

## Система трекинга игроков

### Архитектура трекинга

```
PlayerTrackerSystemManager → IPlayerTrackerSystem → Renderer
```

### Типы систем трекинга

1. **SyncedPlayerTrackerSystem**
   - Синхронизированная система
   - Серверная поддержка

2. **Моды интеграции**
   - FTB Teams
   - Другие моды

### Компоненты трекинга

- `PlayerTrackerMapElementRenderer` - рендеринг
- `PlayerTrackerMenuRenderer` - меню
- `ClientSyncedTrackedPlayerManager` - менеджер

## Обработка ошибок

### Компоненты

1. **CrashHandler**
   - Обработка сбоев
   - Логирование ошибок

2. **SilentException**
   - Тихие исключения
   - Некритичные ошибки

3. **OpenGLException**
   - Ошибки OpenGL
   - Восстановление после ошибок

### Стратегия обработки

- Graceful degradation
- Логирование всех ошибок
- Восстановление состояния

## Оптимизации производительности

### Стратегии оптимизации

1. **Lazy Loading**
   - Загрузка по требованию
   - Приоритизация регионов

2. **Кэширование**
   - Кэш цветов блоков
   - Кэш форм блоков

3. **Пул ресурсов**
   - Переиспользование объектов
   - Снижение нагрузки на GC

4. **Асинхронная обработка**
   - Отдельные потоки
   - Неблокирующие операции

5. **Ограничения**
   - MapLimiter для контроля нагрузки
   - Настройки производительности

## Расширяемость

### API для разработчиков

#### Добавление элементов карты

```java
// Реализация интерфейса
public class CustomElement implements MapElement {
    // Реализация методов
}
```

#### Создание подсветок

```java
// Наследование от AbstractHighlighter
public class CustomHighlighter extends AbstractHighlighter {
    // Реализация подсветки
}
```

#### Интеграция с модами

```java
// Регистрация через SupportMods
SupportMods.registerCustomIntegration(...);
```

### Точки расширения

1. **MapElementReader/MapElementRenderer**
   - Кастомные элементы
   - Кастомный рендеринг

2. **AbstractHighlighter**
   - Кастомные подсветки
   - Визуализация данных

3. **IPlayerTrackerSystem**
   - Кастомные системы трекинга
   - Интеграция с модами

## Потоки выполнения

### Главный поток

- Обработка событий Minecraft
- Обновление GUI
- Синхронизация данных

### MapRunner поток

- Обработка карты
- Загрузка регионов
- Обновление текстур

### Потоки рендеринга

- Асинхронный рендеринг
- Подготовка текстур
- Оптимизация производительности

### Синхронизация

- Использование объектов синхронизации
- Безопасность потоков
- Предотвращение гонок данных

## Управление памятью

### Компоненты

1. **ByteBufferDeallocator**
   - Деаллокация буферов
   - Управление памятью

2. **GLObjectDeleter**
   - Удаление OpenGL объектов
   - Очистка ресурсов GPU

3. **Пул ресурсов**
   - Переиспользование
   - Снижение аллокаций

### Стратегия управления

- Автоматическая очистка
- Отслеживание использования
- Предотвращение утечек

## Версионирование и миграция

### Формат версий

- Версия мода: `{minecraft_version}_{mod_version}`
- Версия файлов: отдельная система версионирования

### Миграция данных

- Автоматическая миграция при загрузке
- Сохранение совместимости
- Обработка старых форматов

## Тестирование и отладка

### Режимы отладки

- `detailed_debug` - детальная отладка
- `extraDebug` - дополнительная отладка
- `pauseRequests` - пауза запросов

### Инструменты

- Логирование через Log4j
- Обработка исключений
- Информация о производительности

